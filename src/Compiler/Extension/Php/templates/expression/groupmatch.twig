{% set result_var = result_varname(expr) %}
{{ expr_comment(expr) }}
{{ result_var }} = null;
if (preg_match({{ repr_regexp(expr.matcher.compiledPattern) }}, $this->text, $matches, PREG_OFFSET_CAPTURE, $this->pos)) {
    $start = $this->pos;
    $end = $this->pos += strlen($matches[0][0]);
    if (!$this->isCapturing) {
        {{ result_var }} = true;
    } else {
{#{% if expr.captureCount == 1 %}#}
        {#list($match, $offset) = $matches[1];#}
        {#{{ result_var }} = new Terminal('{{ expr.name }}', $offset, $offset + strlen($match), $match);#}
{#{% else %}-#}
        $children = [];
        foreach (array_slice($matches, 1) as list($match, $offset)) {
            $children[] = new Terminal('', $offset, $offset + strlen($match), $match);
        }
        {{ result_var }} = new Composite('{{ expr.name }}', $start, $end, $children);
{#{% endif %}#}
    }
} else {
    {{ macros.error(expr)|indent }}
}
