{% set result_var = result_varname(expr) %}
{% set match_var = '$match_' ~ expr.id %}
{% set pos_var = position_varname(expr) %}
{% set children_var = '$children_' ~ expr.id %}
{# node_name can be set by NamedSequence expressions #}
{% set node_name = node_name|default(expr.name) %}
{{ expr_comment(expr) }}
{{ result_var }} = null;
{{ pos_var }} = $this->pos;
{{ match_var }} = true;
{{ children_var }} = $this->isCapturing ? [] : null;
do {
{% for child in expr %}
    {{ render_expr(child)|indent }}
    {%- set subres_var = result_varname(child) %}
    if (!{{ subres_var }}) {
        {{ match_var }} = false;
        break;
    }
    if ($this->isCapturing && {{ subres_var }} !== true) {{ children_var }}[] = {{ subres_var }};
{% endfor %}
} while(0);
if ({{ match_var }}) {
    {{ result_var }} = $this->isCapturing ? new Composite('{{ node_name }}', {{ pos_var }}, $this->pos, {{ children_var }}) : true;
} else {
    $this->pos = {{ pos_var }};
}
